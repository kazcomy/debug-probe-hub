#cloud-config
# Debug Probe Hub - Cloud-init User Data
#
# Usage: Use this file when creating a VM in Proxmox
# This will automatically configure the VM on first boot

# Hostname
hostname: debug-probe-hub

# Users
users:
  - name: debug
    groups: [sudo, docker]
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    # Add your SSH public key here
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... your-public-key-here

# Timezone
timezone: Asia/Tokyo

# Package updates
package_update: true
package_upgrade: true

# Install packages
packages:
  - git
  - python3
  - python3-pip
  - curl
  - udev
  - usbutils
  - jq
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release

# Run commands on first boot
runcmd:
  # Install Docker
  - curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
  - sh /tmp/get-docker.sh
  - usermod -aG docker debug
  - systemctl enable docker
  - systemctl start docker

  # Install Python dependencies
  - pip3 install --upgrade pip
  - pip3 install pyyaml

  # Clone debug-probe-hub repository
  - git clone https://github.com/yourusername/debug-probe-hub.git /opt/debug-probe-hub
  - chown -R debug:debug /opt/debug-probe-hub

  # Run setup script
  - cd /opt/debug-probe-hub && sudo -u debug bash setup.sh || true

  # Install systemd service
  - cp /opt/debug-probe-hub/deploy/systemd/debug-probe-hub.service /etc/systemd/system/
  - systemctl daemon-reload
  - systemctl enable debug-probe-hub.service
  - systemctl start debug-probe-hub.service

# Create working directories
write_files:
  - path: /tmp/flash_staging/.keep
    content: ""
    permissions: '0777'

# Final message
final_message: |
  Debug Probe Hub setup complete!

  Access the server at: http://<your-ip>:8080

  SSH in as 'debug' user to manage the system.

  Check status:
    systemctl status debug-probe-hub
    docker ps
    curl http://localhost:8080/status
