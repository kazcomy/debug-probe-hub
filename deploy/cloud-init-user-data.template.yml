#cloud-config
# Debug Probe Hub - Cloud-init User Data Template
#
# Usage:
# 1. Copy this file to cloud-init-user-data.yml (gitignored)
# 2. Edit the TODO sections with your actual values
# 3. Upload to Proxmox: scp deploy/cloud-init-user-data.yml root@proxmox:/var/lib/vz/snippets/debug-probe-hub-user.yml

# Hostname
hostname: debug-probe-hub

# SSH access
# - This template is fixed to SSH key-only authentication.
# - Password authentication over SSH is intentionally disabled.
ssh_pwauth: false

# Users TODO: Customize this section
users:
  - name: YOUR_USERNAME_HERE  # TODO: Change to your username
    groups: [sudo]
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    shell: /bin/bash
    lock_passwd: true
    ssh_authorized_keys:
      - YOUR_SSH_PUBLIC_KEY_HERE  # TODO: Add your SSH public key (required)

# Timezone TODO: Change if needed
timezone: Asia/Tokyo

# Package updates
package_update: true
package_upgrade: true

# Install packages
packages:
  - git
  - python3
  - python3-pip
  - curl
  - udev
  - usbutils
  - jq                      # JSON processor for API queries
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release

# Run commands on first boot
runcmd:
  # Install Docker
  - curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
  - sh /tmp/get-docker.sh
  - usermod -aG docker YOUR_USERNAME_HERE  # TODO: Replace with your username (same as users[0].name)
  - systemctl enable docker
  - systemctl start docker

  # Install Docker Compose
  - curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  - ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose

  # Install Python dependencies (use --break-system-packages for Ubuntu 24.04+)
  - pip3 install --break-system-packages --upgrade pip
  - pip3 install --break-system-packages pyyaml

  # Clone debug-probe-hub repository
  - git clone https://github.com/YOUR_GITHUB_USERNAME/debug-probe-hub.git /opt/debug-probe-hub  # TODO: Change GitHub username
  - chown -R YOUR_USERNAME_HERE:YOUR_USERNAME_HERE /opt/debug-probe-hub  # TODO: Replace with your username

  # Install systemd services (replace user placeholder)
  - sed 's/User=debug/User=YOUR_USERNAME_HERE/g; s/Group=debug/Group=YOUR_USERNAME_HERE/g' /opt/debug-probe-hub/deploy/systemd/debug-probe-hub-pre-setup.service > /etc/systemd/system/debug-probe-hub-pre-setup.service
  - sed 's/User=debug/User=YOUR_USERNAME_HERE/g; s/Group=debug/Group=YOUR_USERNAME_HERE/g' /opt/debug-probe-hub/deploy/systemd/debug-probe-hub-setup.service > /etc/systemd/system/debug-probe-hub-setup.service
  - sed 's/User=debug/User=YOUR_USERNAME_HERE/g; s/Group=debug/Group=YOUR_USERNAME_HERE/g' /opt/debug-probe-hub/deploy/systemd/debug-probe-hub.service > /etc/systemd/system/debug-probe-hub.service
  - systemctl daemon-reload

  # Run pre-setup only (udev rules, Python deps, etc. - STOPS before docker build)
  - systemctl start debug-probe-hub-pre-setup.service

  # Enable (not start) the setup and main services - user will run them manually
  - systemctl enable debug-probe-hub-setup.service
  - systemctl enable debug-probe-hub.service

# Create working directories
write_files:
  - path: /tmp/flash_staging/.keep
    content: ""
    permissions: '0777'

# Final message
final_message: |
  ========================================
  Debug Probe Hub - Pre-Setup Complete!
  ========================================

  Phase 1 (Automated) is done. Docker and dependencies are installed.

  Next: SSH in and complete Phase 2 (Manual Setup)
    ssh YOUR_USERNAME_HERE@<your-ip>

  REQUIRED STEPS:

  1. Set local password after SSH login (makepw):
     sudo passwd YOUR_USERNAME_HERE

  2. Configure WCH Toolchain Access:
     cd /opt/debug-probe-hub
     cp docker-compose.override.yml.template docker-compose.override.yml
     nano docker-compose.override.yml
     # Add your GitHub token to WCH_TOOLCHAIN_URL

  3. Build Docker Images (10-20 minutes):
     sudo systemctl start debug-probe-hub-setup
     journalctl -u debug-probe-hub-setup -f

  4. Start Debug Probe Hub:
     sudo systemctl start debug-probe-hub
     systemctl status debug-probe-hub

  5. Verify:
     docker ps
     curl http://localhost:8080/status

  See /opt/debug-probe-hub/docs/deploy.md for detailed instructions.
  ========================================
